<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Air Pollutant Interpolation (Methods)</title>

    <!-- ArcGIS CSS -->
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.28/esri/themes/light/main.css"
    />

    <!-- Libraries -->
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/kriging.js/kriging.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/oevgeny/kriging.js/kriging.min.js"></script>
    <script src="kriging.js"></script>

    <!-- ArcGIS Maps SDK -->
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #controls {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: white;
        padding: 0;
        border-radius: 8px;
        width: 280px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        font-family: "Avenir Next", Helvetica, Arial, sans-serif;
        z-index: 99;
        overflow: hidden;
      }

      /* Tabs */
      .tabs {
        display: flex;
        background: #f4f4f4;
        border-bottom: 1px solid #ddd;
      }
      .tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: #666;
        border-bottom: 3px solid transparent;
      }
      .tab-btn.active {
        color: #0079c1;
        border-bottom: 3px solid #0079c1;
        background: white;
      }
      .tab-btn:hover {
        background: #e0e0e0;
      }

      /* Panels */
      .panel-content {
        padding: 20px;
        display: none;
      }
      .panel-content.active {
        display: block;
      }

      h3 {
        margin-top: 0;
        color: #0079c1;
        font-size: 1.1rem;
        margin-bottom: 15px;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 0.9rem;
      }
      select,
      input[type="date"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        box-sizing: border-box;
      }

      #status {
        padding: 0 20px 15px 20px;
        border-top: 1px solid #eee;
        font-size: 0.85rem;
        color: #555;
        font-style: italic;
        min-height: 1.2em;
      }
      .error-msg {
        color: #d90000;
        font-weight: bold;
        font-style: normal;
      }
      .success-msg {
        color: #28a745;
        font-weight: bold;
        font-style: normal;
      }
    </style>
  </head>

  <body>
    <div id="viewDiv"></div>

    <div id="controls">
      <!-- Tabs -->
      <div class="tabs">
        <button
          class="tab-btn active"
          id="tab-daily"
          onclick="switchTab('daily')"
        >
          Daily (VOC)
        </button>
        <button class="tab-btn" id="tab-hourly" onclick="switchTab('hourly')">
          Hourly (PM/Gas)
        </button>
      </div>

      <!-- Common Settings (Method) -->
      <div style="padding: 20px 20px 0 20px; border-bottom: 1px solid #f0f0f0">
        <div class="form-group">
          <label>Interpolation Method:</label>
          <select id="methodSelect">
            <option value="hex" selected>IDW (Hexagon)</option>
            <option value="square">IDW (Square Grid)</option>
            <option value="voronoi">Nearest Neighbor (Voronoi)</option>
            <option value="kriging">Kriging</option>
          </select>
        </div>
      </div>

      <!-- Daily Panel -->
      <div id="panel-daily" class="panel-content active">
        <h3>Daily Data (VOC)</h3>
        <div class="form-group">
          <label>Select Date:</label>
          <select id="dailyDateSelect" disabled>
            <option>Loading Data...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Select Compound:</label>
          <select id="dailyCompoundSelect" disabled>
            <option>-- First Select Date --</option>
          </select>
        </div>
      </div>

      <!-- Hourly Panel -->
      <div id="panel-hourly" class="panel-content">
        <h3>Hourly Data (PM/Gas)</h3>
        <div class="form-group">
          <label>Select Date:</label>
          <select id="hourlyDateSelect" disabled>
            <option>Loading Dates...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Select Time (CST):</label>
          <select id="hourlyTimeSelect" disabled>
            <option>-- Select Date First --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Select Pollutant:</label>
          <select id="hourlyPollutantSelect" disabled>
            <option value="">-- Select Pollutant --</option>
            <option value="PM2.5_adj">PM 2.5</option>
            <option value="PM10_adj">PM 10</option>
            <option value="NO2_adj">NO2</option>
            <option value="SO2_adj">SO2</option>
            <option value="CO_adj">CO</option>
            <option value="O3_adj">Ozone (O3)</option>
            <option value="Temp">Temperature</option>
            <option value="RH">Humidity</option>
            <option value="BP">Pressure</option>
          </select>
        </div>
      </div>

      <div id="status">Initializing...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/oevgeny/kriging.js/kriging.min.js"></script>

    <script>
      // ---------------------------------------------------------
      // 1. CONFIGURATION
      // ---------------------------------------------------------
      const DAILY_ZIP_URL =
        "https://raw.githubusercontent.com/gladcolor/air_pollutants/refs/heads/master/VOC_With_Coords.zip";
      const HOURLY_DATES_URL =
        "https://raw.githubusercontent.com/gladcolor/air_pollutants/refs/heads/master/dates/All_dates.csv";
      const HOURLY_BASE_URL =
        "https://raw.githubusercontent.com/gladcolor/air_pollutants/refs/heads/master/dates/Hourly_adj_BlueSky_";

      let dailyData = [];
      let hourlyData = [];
      let currentMode = "daily";
      let webmap, view, interpolationLayer, pointsLayer;

      // ---------------------------------------------------------
      // 2. UI LOGIC
      // ---------------------------------------------------------
      window.switchTab = function (mode) {
        currentMode = mode;
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelectorAll(".panel-content")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById(`tab-${mode}`).classList.add("active");
        document.getElementById(`panel-${mode}`).classList.add("active");

        // Clear Map
        if (interpolationLayer) {
          webmap.remove(interpolationLayer);
          interpolationLayer = null;
        }
        if (pointsLayer) {
          webmap.remove(pointsLayer);
          pointsLayer = null;
        }

        document.getElementById(
          "status"
        ).textContent = `Switched to ${mode} mode.`;
      };

      // Method Change Listener
      document.getElementById("methodSelect").addEventListener("change", () => {
        if (currentMode === "daily") {
          const date = document.getElementById("dailyDateSelect").value;
          const comp = document.getElementById("dailyCompoundSelect").value;
          if (date && comp) runVisualization(dailyData, "daily", date, comp);
        } else {
          const time = document.getElementById("hourlyTimeSelect").value;
          const poll = document.getElementById("hourlyPollutantSelect").value;
          if (time && poll) runVisualization(hourlyData, "hourly", time, poll);
        }
      });

      // ---------------------------------------------------------
      // 3. MAP INITIALIZATION
      // ---------------------------------------------------------
      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/layers/GeoJSONLayer",
        "esri/widgets/Legend",
        "esri/widgets/Expand",
      ], function (WebMap, MapView, GeoJSONLayer, Legend, Expand) {
        webmap = new WebMap({
          portalItem: { id: "63a264ef1b5f4bbab8cdb2b592c29ae6" },
          basemap: "gray-vector",
        });

        view = new MapView({
          container: "viewDiv",
          map: webmap,
          center: [-94.1, 30.08],
          zoom: 11,
        });

        view.ui.add(
          new Expand({
            view: view,
            content: new Legend({ view: view }),
            expanded: true,
          }),
          "bottom-left"
        );

        // Load Data
        loadDailyData();
        loadHourlyDates();
      });

      // ---------------------------------------------------------
      // 4. DATA LOADERS
      // ---------------------------------------------------------
      function loadDailyData() {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = "Downloading Daily VOC Data...";

        fetch(DAILY_ZIP_URL)
          .then((r) => {
            if (!r.ok) throw new Error("Network Error");
            return r.arrayBuffer();
          })
          .then((d) => JSZip.loadAsync(d))
          .then((zip) => {
            const filename = Object.keys(zip.files).find(
              (n) => n.endsWith(".csv") && !n.startsWith("__")
            );
            return zip.files[filename].async("string");
          })
          .then((csvText) => {
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: true,
              skipEmptyLines: true,
              complete: (results) => {
                dailyData = results.data;
                initDailyUI();
                statusDiv.textContent = "Daily Data Ready.";
                statusDiv.className = "success-msg";
              },
            });
          })
          .catch((e) => {
            statusDiv.textContent = "Error loading Daily data.";
            statusDiv.className = "error-msg";
          });
      }

      function initDailyUI() {
        const dateSelect = document.getElementById("dailyDateSelect");
        const compSelect = document.getElementById("dailyCompoundSelect");
        const dates = [...new Set(dailyData.map((d) => d.Date_collect))]
          .filter(Boolean)
          .sort();

        dateSelect.innerHTML = `<option value="">-- Select Date --</option>`;
        dates.forEach(
          (d) => (dateSelect.innerHTML += `<option value="${d}">${d}</option>`)
        );
        dateSelect.disabled = false;

        dateSelect.addEventListener("change", () => {
          const date = dateSelect.value;
          if (!date) return;
          const filtered = dailyData.filter((d) => d.Date_collect === date);
          const compounds = [...new Set(filtered.map((d) => d.Compound))]
            .filter(Boolean)
            .sort();
          compSelect.innerHTML = `<option value="">-- Select Compound --</option>`;
          compounds.forEach(
            (c) =>
              (compSelect.innerHTML += `<option value="${c}">${c}</option>`)
          );
          compSelect.disabled = false;
        });

        compSelect.addEventListener("change", () => {
          const date = dateSelect.value;
          const comp = compSelect.value;
          if (date && comp) runVisualization(dailyData, "daily", date, comp);
        });
      }

      function loadHourlyDates() {
        fetch(HOURLY_DATES_URL)
          .then((r) => r.text())
          .then((csvText) => {
            Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              complete: (results) => {
                const dates = results.data
                  .map((d) => d.date)
                  .filter(Boolean)
                  .sort();
                const s = document.getElementById("hourlyDateSelect");
                s.innerHTML = `<option value="">-- Select Date --</option>`;
                dates.forEach(
                  (d) => (s.innerHTML += `<option value="${d}">${d}</option>`)
                );
                s.disabled = false;
              },
            });
          });
      }

      document
        .getElementById("hourlyDateSelect")
        .addEventListener("change", (e) => {
          if (e.target.value) loadHourlyDataForDate(e.target.value);
        });

      function loadHourlyDataForDate(date) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = `Fetching data for ${date}...`;

        // Reset Dropdowns
        document.getElementById(
          "hourlyTimeSelect"
        ).innerHTML = `<option>Loading...</option>`;
        document.getElementById("hourlyTimeSelect").disabled = true;
        document.getElementById("hourlyPollutantSelect").disabled = true;

        fetch(`${HOURLY_BASE_URL}${date}.csv`)
          .then((r) => r.text())
          .then((csvText) => {
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: true,
              skipEmptyLines: true,
              complete: (results) => {
                hourlyData = results.data;
                initHourlyTimeUI();
                statusDiv.textContent = `Data loaded for ${date}`;
                statusDiv.className = "success-msg";
              },
            });
          })
          .catch((e) => {
            statusDiv.textContent = "Data load failed.";
            statusDiv.className = "error-msg";
          });
      }

      function initHourlyTimeUI() {
        const times = [...new Set(hourlyData.map((d) => d.Time_Texas))]
          .filter(Boolean)
          .sort();
        const tSelect = document.getElementById("hourlyTimeSelect");
        tSelect.innerHTML = `<option value="">-- Select Time --</option>`;
        times.forEach(
          (t) => (tSelect.innerHTML += `<option value="${t}">${t}</option>`)
        );
        tSelect.disabled = false;
        document.getElementById("hourlyPollutantSelect").disabled = false;
      }

      function checkHourlyRun() {
        const time = document.getElementById("hourlyTimeSelect").value;
        const poll = document.getElementById("hourlyPollutantSelect").value;
        const label = document.getElementById("hourlyPollutantSelect").options[
          document.getElementById("hourlyPollutantSelect").selectedIndex
        ].text;
        if (time && poll)
          runVisualization(hourlyData, "hourly", time, poll, label);
      }

      document
        .getElementById("hourlyTimeSelect")
        .addEventListener("change", checkHourlyRun);
      document
        .getElementById("hourlyPollutantSelect")
        .addEventListener("change", checkHourlyRun);

      function fillMissingValueForPoint(
        allRecords,
        stationID,
        targetTime,
        pollutantField,
        hourThreshold = 12
      ) {
        // 1. 获取该站点所有有效记录
        const stationRecords = allRecords.filter(
          (r) => r.HouseID === stationID && Number.isFinite(r[pollutantField])
        );

        if (stationRecords.length === 0) {
          return null; // 完全没有有效值
        }

        // 将 "HH:mm" 转成 Date
        const toDate = (t) => new Date(`2000-01-01T${t}:00`);
        const targetDate = toDate(targetTime);

        // 找前后记录
        const earlier = stationRecords
          .filter((r) => toDate(r.Time_Texas) < targetDate)
          .sort((a, b) => toDate(b.Time_Texas) - toDate(a.Time_Texas));

        const later = stationRecords
          .filter((r) => toDate(r.Time_Texas) > targetDate)
          .sort((a, b) => toDate(a.Time_Texas) - toDate(b.Time_Texas));

        let prev = null,
          next = null;

        // 最近的前一个
        if (earlier.length > 0) {
          const diffHours = Math.abs(
            (targetDate - toDate(earlier[0].Time_Texas)) / 36e5
          );
          if (diffHours <= hourThreshold) {
            prev = earlier[0][pollutantField];
          }
        }

        // 最近的后一个
        if (later.length > 0) {
          const diffHours = Math.abs(
            (toDate(later[0].Time_Texas) - targetDate) / 36e5
          );
          if (diffHours <= hourThreshold) {
            next = later[0][pollutantField];
          }
        }

        // 情况 1：前后都有（都在阈值内）
        if (prev != null && next != null) {
          return (prev + next) / 2;
        }

        // 情况 2：只有前一个
        if (prev != null) return prev;

        // 情况 3：只有后一个
        if (next != null) return next;

        // 情况 4：前后都超时 → 不补值
        return null;
      }

      // ---------------------------------------------------------
      // 5. VISUALIZATION LOGIC
      // ---------------------------------------------------------
      function getGeometricBreaks(minVal, maxVal, nClasses = 9) {
        // 几何分级要求 > 0，如果有 <=0 的情况可以稍微平移或退化成等距
        if (minVal <= 0) {
          // 简单 fallback：改成等距分级
          const step = (maxVal - minVal) / nClasses;
          const breaks = [];
          for (let i = 0; i <= nClasses; i++) {
            breaks.push(minVal + step * i);
          }
          return breaks;
        }

        const breaks = [];
        const ratio = Math.pow(maxVal / minVal, 1 / nClasses); // 公比
        for (let i = 0; i <= nClasses; i++) {
          breaks.push(minVal * Math.pow(ratio, i));
        }
        return breaks;
      }

      function runVisualization(dataset, mode, key1, key2, labelOverride) {
        const statusDiv = document.getElementById("status");
        const method = document.getElementById("methodSelect").value;

        let filtered = [];
        let label = "";

        if (mode === "daily") {
          filtered = dataset.filter(
            (d) => d.Date_collect === key1 && d.Compound === key2
          );
          filtered = filtered.map((d) => ({ ...d, value: d.Adj_ppbV }));
          label = key2;
        } else {
          filtered = dataset.filter((d) => d.Time_Texas === key1);
          filtered = filtered.map((d) => {
            let v = d[key2];

            // 如果没有有效值 → 尝试补值（±12h 内）
            if (!Number.isFinite(v)) {
              v = fillMissingValueForPoint(dataset, d.HouseID, key1, key2, 12);
            }

            return { ...d, value: v };
          });
          label = labelOverride || key2;
        }

        // STRICT FILTER: Remove nulls AND non-finite numbers (NaN, Infinity)
        const validData = filtered.filter(
          (d) =>
            d.value != null &&
            Number.isFinite(d.value) &&
            d.Lon != null &&
            d.Lat != null
        );

        if (validData.length < 3) {
          statusDiv.textContent = `Insufficient unique points (${validData.length}). Need 3+.`;
          statusDiv.className = "error-msg";
          if (interpolationLayer) {
            webmap.remove(interpolationLayer);
            interpolationLayer = null;
          }
          if (pointsLayer) {
            webmap.remove(pointsLayer);
            pointsLayer = null;
          }
          return;
        }

        if (interpolationLayer) {
          webmap.remove(interpolationLayer);
          interpolationLayer = null;
        }
        if (pointsLayer) {
          webmap.remove(pointsLayer);
          pointsLayer = null;
        }
        webmap.layers.forEach((l) => (l.visible = false));

        const points = turf.featureCollection(
          validData.map((d) =>
            turf.point([d.Lon, d.Lat], {
              value: d.value,
              HouseID: String(d.HouseID),
            })
          )
        );

        const values = validData.map((d) => d.value);
        let minVal = Math.min(...values);
        let maxVal = Math.max(...values);
        if (minVal === maxVal) {
          minVal -= 0.0001;
          maxVal += 0.0001;
        }

        let grid;
        try {
          if (method === "hex") {
            grid = turf.interpolate(points, 0.05, {
              gridType: "hex",
              property: "value",
              units: "kilometers",
            });
          } else if (method === "square") {
            grid = turf.interpolate(points, 0.2, {
              gridType: "square",
              property: "value",
              units: "kilometers",
            });
          } else if (method === "voronoi") {
            const bbox = turf.bbox(points);
            const options = {
              bbox: [
                bbox[0] - 0.05,
                bbox[1] - 0.05,
                bbox[2] + 0.05,
                bbox[3] + 0.05,
              ],
            };
            grid = turf.voronoi(points, options);
            grid.features = grid.features
              .map((f, i) => {
                if (!f) return null;
                f.properties = points.features[i].properties;
                return f;
              })
              .filter((f) => f != null);
          } else if (method === "kriging") {
            // 1. 准备数据
            const values = validData.map((d) => d.value);
            const lons = validData.map((d) => d.Lon);
            const lats = validData.map((d) => d.Lat);

            // 2. 拟合 variogram
            const variogram = kriging.train(
              values,
              lons,
              lats,
              "exponential",
              0.005, // sigma2
              5 // alpha
            );

            // 3. 构建 polygon（而不是传 bbox）
            const bbox = turf.bbox(points);
            const xMin = bbox[0],
              yMin = bbox[1],
              xMax = bbox[2],
              yMax = bbox[3];

            const poly = [
              [
                [xMin, yMin],
                [xMax, yMin],
                [xMax, yMax],
                [xMin, yMax],
                [xMin, yMin],
              ],
            ];

            // 4. 生成 kriging grid
            const cell = (xMax - xMin) / 300; // 分辨率，300格
            const gridResult = kriging.grid(poly, variogram, cell);

            // 5. 转成 GeoJSON（ArcGIS 能显示）
            const geojson = {
              type: "FeatureCollection",
              features: [],
            };

            for (let i = 0; i < gridResult.length; i++) {
              for (let j = 0; j < gridResult[0].length; j++) {
                const z = gridResult[i][j];
                if (z == undefined) continue;

                const x1 = xMin + i * cell;
                const y1 = yMin + j * cell;
                const x2 = x1 + cell;
                const y2 = y1 + cell;

                const polyCell = turf.polygon(
                  [
                    [
                      [x1, y1],
                      [x2, y1],
                      [x2, y2],
                      [x1, y2],
                      [x1, y1],
                    ],
                  ],
                  { value: z }
                );

                geojson.features.push(polyCell);
              }
            }

            grid = geojson;
          }
        } catch (e) {
          console.error(e);
          statusDiv.textContent = "Math Error: " + e.message;
          statusDiv.className = "error-msg";
          return;
        }

        const gridUrl = URL.createObjectURL(
          new Blob([JSON.stringify(grid)], { type: "application/json" })
        );
        const ptsUrl = URL.createObjectURL(
          new Blob([JSON.stringify(points)], { type: "application/json" })
        );

        require(["esri/layers/GeoJSONLayer"], function (GeoJSONLayer) {
          // 1. 计算 9 级几何分级断点
          const breaks = getGeometricBreaks(minVal, maxVal, 9);

          // 2. 定义 9 个颜色（从浅到深 / 低到高）
          const colors = [
            "#ffffe5",
            "#fff7bc",
            "#fee391",
            "#fec44f",
            "#fe9929",
            "#ec7014",
            "#cc4c02",
            "#993404",
            "#662506",
          ];

          // 3. 动态生成 9 个 classBreakInfos
          const classBreakInfos = [];
          for (let i = 0; i < 9; i++) {
            classBreakInfos.push({
              minValue: breaks[i],
              maxValue: breaks[i + 1],
              symbol: {
                type: "simple-fill",
                color: colors[i],
                outline:
                  method === "voronoi"
                    ? { width: 1, color: [255, 255, 255, 0.4] }
                    : null, // hex / square 不要边框
              },
              label: `${breaks[i].toFixed(2)} – ${breaks[i + 1].toFixed(2)}`,
            });
          }

          const classRenderer = {
            type: "class-breaks",
            field: "value",
            defaultSymbol: {
              type: "simple-fill",
              color: "#cccccc",
              outline: null,
            },
            classBreakInfos: classBreakInfos,
          };

          interpolationLayer = new GeoJSONLayer({
            url: gridUrl,
            title: `Interpolation: ${label}`,
            opacity: 0.75,
            renderer: classRenderer,
            popupTemplate: {
              title: label,
              content: "Value: {value}",
            },
          });

          pointsLayer = new GeoJSONLayer({
            url: ptsUrl,
            title: "Sensors",
            renderer: {
              type: "simple",
              symbol: {
                type: "simple-marker",
                style: "circle",
                color: "black",
                size: "6px",
                outline: { color: "white", width: 1 },
              },
            },
            labelingInfo: [
              {
                symbol: {
                  type: "text",
                  color: "black",
                  haloColor: "white",
                  haloSize: 1,
                  font: { family: "Arial", size: 9, weight: "bold" },
                },
                labelPlacement: "above-center",
                labelExpressionInfo: { expression: "Text($feature.HouseID)" },
              },
            ],
            popupTemplate: { title: "House {HouseID}", content: "{value}" },
          });

          webmap.add(interpolationLayer);
          webmap.add(pointsLayer);

          view.goTo(points).catch((err) => {});
          statusDiv.textContent = `Visualizing ${label} (${validData.length} records)`;
          statusDiv.className = "success-msg";
        });
      }
    </script>
  </body>
</html>
