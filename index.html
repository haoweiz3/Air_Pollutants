<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Air Pollutant Interpolation (Daily Only)</title>

  <!-- Load ArcGIS CSS -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />

  <!-- Load Third-Party Libraries -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Load ArcGIS Maps SDK for JavaScript -->
  <script src="https://js.arcgis.com/4.28/"></script>

  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #controls {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      width: 280px;
      font-family: "Avenir Next", "Helvetica Neue", Helvetica, Arial, sans-serif;
      z-index: 99;
    }

    h3 {
      margin-top: 0;
      color: #0079c1;
      font-size: 1.2rem;
      margin-bottom: 15px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }

    .form-group { margin-bottom: 15px; }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }

    #status {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      font-size: 0.85rem;
      color: #555;
      font-style: italic;
      min-height: 1.2em;
    }
    
    .error-msg { color: #d90000 !important; font-weight: bold; font-style: normal !important; }
    .success-msg { color: #28a745 !important; font-weight: bold; font-style: normal !important; }
  </style>
</head>

<body>
  <div id="viewDiv"></div>

  <div id="controls">
    <h3>Daily Air Quality (VOC)</h3>
    
    <div class="form-group">
      <label>Select Date:</label>
      <select id="dateSelect" disabled>
        <option value="">Loading data...</option>
      </select>
    </div>

    <div class="form-group">
      <label>Select Compound:</label>
      <select id="compoundSelect" disabled>
        <option value="">-- First Select Date --</option>
      </select>
    </div>
    
    <div id="status">Initializing...</div>
  </div>

  <script>
    // ---------------------------------------------------------
    // GLOBAL STATE
    // ---------------------------------------------------------
    let dailyData = [];
    const DATA_URL = "https://raw.githubusercontent.com/gladcolor/air_pollutants/master/VOC_With_Coords.zip";

    require([
      "esri/WebMap", "esri/views/MapView", "esri/layers/GeoJSONLayer",
      "esri/widgets/Legend", "esri/widgets/Expand"
    ], function(WebMap, MapView, GeoJSONLayer, Legend, Expand) {

      // 1. Initialize Map (Forced Center on Beaumont)
      const webmap = new WebMap({
        portalItem: { id: "63a264ef1b5f4bbab8cdb2b592c29ae6" },
        basemap: "gray-vector" 
      });

      const view = new MapView({
        container: "viewDiv",
        map: webmap,
        center: [-94.1, 30.08],
        zoom: 11
      });

      view.ui.add(new Expand({ view: view, content: new Legend({ view: view }), expanded: true }), "bottom-left");

      // Global Layer Refs
      window.webmap = webmap;
      window.interpolationLayer = null;
      window.pointsLayer = null;

      // Start Data Load
      loadData(DATA_URL);

      // ---------------------------------------------------------
      // DATA LOADER (Optimized Blob Extraction)
      // ---------------------------------------------------------
      function loadData(url) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = "Downloading ZIP...";

        fetch(url)
            .then(r => {
                if (!r.ok) throw new Error(`Network Error ${r.status}`);
                return r.arrayBuffer();
            })
            .then(d => JSZip.loadAsync(d))
            .then(zip => {
                const filename = Object.keys(zip.files).find(name => 
                    name.toLowerCase().endsWith('.csv') && !name.startsWith('__MACOSX')
                );
                if (!filename) throw new Error("No CSV found in ZIP");
                
                statusDiv.textContent = "Extracting CSV...";
                return zip.files[filename].async("blob"); // Extract as Blob (Efficient)
            })
            .then(blob => parseCSV(blob))
            .catch(e => {
                console.error(e);
                statusDiv.textContent = "Error: " + e.message;
                statusDiv.className = "error-msg";
            });
      }

      function parseCSV(fileBlob) {
          const statusDiv = document.getElementById("status");
          statusDiv.textContent = "Parsing CSV...";

          Papa.parse(fileBlob, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            worker: true, // Run in background thread
            complete: function(results) {
              if (!results.data || results.data.length === 0) {
                  statusDiv.textContent = "Error: CSV is empty.";
                  return;
              }
              dailyData = results.data;
              initUI();
              statusDiv.textContent = "Data Ready. Select a date.";
              statusDiv.className = "success-msg";
            },
            error: function(err) { 
                console.error(err); 
                statusDiv.textContent = "CSV Parse Error";
                statusDiv.className = "error-msg";
            }
          });
      }

      // ---------------------------------------------------------
      // UI LOGIC
      // ---------------------------------------------------------
      function initUI() {
          const dSelect = document.getElementById("dateSelect");
          const cSelect = document.getElementById("compoundSelect");
          
          // Get unique dates
          const dates = [...new Set(dailyData.map(d => d.Date_collect))].filter(Boolean).sort();
          
          dSelect.innerHTML = `<option value="">-- Select Date --</option>`;
          dates.forEach(d => dSelect.innerHTML += `<option value="${d}">${d}</option>`);

          dSelect.disabled = false;
          cSelect.disabled = false;

          dSelect.addEventListener("change", () => { 
              updateCompounds();
              checkRun();
          });
          
          cSelect.addEventListener("change", checkRun);
      }

      function updateCompounds() {
          const dSelect = document.getElementById("dateSelect");
          const cSelect = document.getElementById("compoundSelect");
          
          if (!dSelect.value) {
              cSelect.innerHTML = `<option value="">-- First Select Date --</option>`;
              return;
          }

          const filtered = dailyData.filter(d => d.Date_collect === dSelect.value);
          const compounds = [...new Set(filtered.map(d => d.Compound))].filter(Boolean).sort();
          
          const prevVal = cSelect.value;
          cSelect.innerHTML = `<option value="">-- Select Compound --</option>`;
          compounds.forEach(c => cSelect.innerHTML += `<option value="${c}">${c}</option>`);
          
          // Try to preserve selection if available
          if(compounds.includes(prevVal)) cSelect.value = prevVal;
      }

      function checkRun() {
          const date = document.getElementById("dateSelect").value;
          const comp = document.getElementById("compoundSelect").value;
          
          if (date && comp) {
              triggerInterpolation(date, comp);
          } else {
              resetMapLayers();
          }
      }

      // ---------------------------------------------------------
      // MAP LOGIC
      // ---------------------------------------------------------
      function resetMapLayers() {
          if (window.interpolationLayer) { window.webmap.remove(window.interpolationLayer); window.interpolationLayer = null; }
          if (window.pointsLayer) { window.webmap.remove(window.pointsLayer); window.pointsLayer = null; }
          
          // Restore base layers visibility
          window.webmap.layers.forEach(l => l.visible = true);
      }

      function triggerInterpolation(date, comp) {
          const statusDiv = document.getElementById("status");
          statusDiv.textContent = "Processing...";
          statusDiv.className = "";
          
          // Yield to UI thread to show "Processing..."
          requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                  runInterpolation(date, comp);
              });
          });
      }

      function runInterpolation(selectedDate, selectedCompound) {
        const statusDiv = document.getElementById("status");

        // Hide Base Layers
        window.webmap.layers.forEach(layer => {
            if (layer !== window.interpolationLayer && layer !== window.pointsLayer) {
                layer.visible = false;
            }
        });

        // Filter Data
        const filteredData = dailyData.filter(d => 
            d.Date_collect === selectedDate && 
            d.Compound === selectedCompound && 
            d.Lon != null && d.Lat != null && d.Adj_ppbV != null
        );

        if (filteredData.length < 3) {
          statusDiv.textContent = `Insufficient data (${filteredData.length} pts). Need 3+.`;
          statusDiv.className = "error-msg";
          resetMapLayers();
          return;
        }

        // Convert to Turf Points
        const points = turf.featureCollection(
          filteredData.map(d => turf.point([d.Lon, d.Lat], { 
            value: d.Adj_ppbV,
            HouseID: String(d.HouseID) 
          }))
        );

        // Stats
        const values = filteredData.map(d => d.Adj_ppbV);
        let minVal = Math.min(...values);
        let maxVal = Math.max(...values);
        if (minVal === maxVal) { minVal -= 0.0001; maxVal += 0.0001; }

        // Interpolate
        let grid;
        try {
          grid = turf.interpolate(points, 0.2, { gridType: 'hex', property: 'value', units: 'kilometers' });
        } catch (e) {
          console.error(e);
          statusDiv.textContent = "Math Error (Points too sparse).";
          statusDiv.className = "error-msg";
          return;
        }

        resetMapLayers();

        // Create Blobs
        const gridUrl = URL.createObjectURL(new Blob([JSON.stringify(grid)], { type: "application/json" }));
        const pointsUrl = URL.createObjectURL(new Blob([JSON.stringify(points)], { type: "application/json" }));

        // 1. Interpolation Layer
        window.interpolationLayer = new GeoJSONLayer({
          url: gridUrl,
          title: `Interpolation: ${selectedCompound}`,
          opacity: 0.75,
          renderer: {
            type: "simple",
            symbol: { type: "simple-fill", outline: { width: 0, color: [0,0,0,0.1] } },
            visualVariables: [{
              type: "color", field: "value",
              stops: [
                { value: minVal, color: "rgba(0, 255, 0, 0.6)", label: `${minVal.toFixed(2)} ppb` },
                { value: (minVal + maxVal)/2, color: "rgba(255, 255, 0, 0.6)" },
                { value: maxVal, color: "rgba(255, 0, 0, 0.6)", label: `${maxVal.toFixed(2)} ppb` }
              ]
            }]
          },
          popupTemplate: { title: "{value} ppb", content: "Estimated Level" }
        });

        // 2. Points Layer
        window.pointsLayer = new GeoJSONLayer({
          url: pointsUrl,
          title: "Sensors",
          renderer: {
            type: "simple",
            symbol: { type: "simple-marker", style: "circle", color: "black", size: "6px", outline: {color:"white", width:1} }
          },
          labelingInfo: [{
            symbol: { type: "text", color: "black", haloColor: "white", haloSize: 1, font: {family: "Arial", size: 10, weight: "bold"} },
            labelPlacement: "above-center",
            labelExpressionInfo: { expression: "Text($feature.HouseID)" }
          }],
          popupTemplate: { title: "House {HouseID}", content: "Value: {value} ppb" }
        });

        window.webmap.add(window.interpolationLayer);
        window.webmap.add(window.pointsLayer);
        
        view.goTo(points).catch(err => {});
        statusDiv.textContent = `Visualizing ${selectedCompound} (${filteredData.length} sensors)`;
        statusDiv.className = "success-msg";
      }
    });
  </script>
</body>
</html>
